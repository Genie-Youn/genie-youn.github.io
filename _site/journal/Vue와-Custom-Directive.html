<!doctype html>
<html>

<head>

  <title>
    
      Vue 디렉티브와 Hook | 오르막길
    
  </title>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8">
  <meta property="og:image:secure_url" content="https://user-images.githubusercontent.com/16642635/63559805-66121600-c58e-11e9-989b-3eb58c2a15ef.jpeg" />

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/syntax.css">
  <!-- Use Atom -->
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="오르막길" />
  <!-- Use RSS-2.0 -->
  <!--<link href="/rss-feed.xml" type="application/rss+xml" rel="alternate" title="오르막길 | 잊기전에 기록하기"/>
  //-->

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Quattrocento+Sans">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>

  <!-- Google Analytics -->
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-146256933-1', 'auto');
  ga('send', 'pageview');
</script>


  <!-- Use Jekyll SEO plugin -->
  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Vue 디렉티브와 Hook | 오르막길</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Vue 디렉티브와 Hook" />
<meta name="author" content="genie-youn" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Photo by frank 35mm on Unsplash" />
<meta property="og:description" content="Photo by frank 35mm on Unsplash" />
<link rel="canonical" href="http://localhost:4000/journal/Vue%EC%99%80-Custom-Directive.html" />
<meta property="og:url" content="http://localhost:4000/journal/Vue%EC%99%80-Custom-Directive.html" />
<meta property="og:site_name" content="오르막길" />
<meta property="og:image" content="http://localhost:4000/35mm-IstXvxHGoA4-unsplash.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-04-26T00:00:00+09:00" />
<script type="application/ld+json">
{"image":"http://localhost:4000/35mm-IstXvxHGoA4-unsplash.jpg","author":{"@type":"Person","name":"genie-youn"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/journal/Vue%EC%99%80-Custom-Directive.html"},"description":"Photo by frank 35mm on Unsplash","@type":"BlogPosting","url":"http://localhost:4000/journal/Vue%EC%99%80-Custom-Directive.html","headline":"Vue 디렉티브와 Hook","dateModified":"2019-04-26T00:00:00+09:00","datePublished":"2019-04-26T00:00:00+09:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


</head>


<body>

  <div class="container">
    <header class="masthead">
  <h3 class="masthead-title">
    <a href="/">오르막길</a>
    <small class="masthead-subtitle">잊기전에 기록하기</small>
    <div class="menu">
  <nav class="menu-content">
    
      <a href="/menu/about.html">About</a>
    
      <a href="/menu/writing.html">Writing</a>
    
  </nav>
  <nav class="social-icons">
    
  
  
    <a href="https://github.com/genie-youn" target="_blank"><i class="fa fa-github" aria-hidden="true"></i></a>
  

  
  
    <a href="https://www.linkedin.com/in/%EC%A7%80%EC%88%98-%EC%9C%A4-78921a11b/" target="_blank"><i class="fa fa-linkedin" aria-hidden="true"></i></a>
  

  
  
    <a href="mailto:yjs930915@gmail.com" target="_blank"><i class="fa fa-envelope" aria-hidden="true"></i></a>
  

  </nav>
</div>

  </h3>
</header>


    <div class="post-container">
      <h1>
  Vue 디렉티브와 Hook
</h1>


  <img src="/assets/img/35mm-IstXvxHGoA4-unsplash.jpg">


<center><small>Photo by frank <a href="https://unsplash.com/@35mm?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">35mm</a> on <a href="https://unsplash.com/">Unsplash</a></small></center>

<p>이번엔 커스텀하게 만든 디렉티브가 예상치 못한 버그를 만들어내서 디버깅을 찍다보니 <code class="highlighter-rouge">unbind</code> 훅을 제대로 구현해 주지 않아 디렉티브 내부의 <code class="highlighter-rouge">innerHTML</code> 이 제대로 초기화되지 않아서 발생한 이슈였다. 이 참에 Vue 와 디렉티브에 관하여 정리하려 한다.</p>

<h2 id="directive">Directive?</h2>

<p>디렉티브는 <code class="highlighter-rouge">v-</code> 접두어를 가진 특별한 attribute 이다. 값으로 단일 자바스크립트 표현식을 받으며 하는 일은 이 표현식의 결과값이 변경되었을 때 ‘반응형’으로 DOM 에 side-effect 를 적용하는 것이다.</p>

<p>가장 처음 접하는 <code class="highlighter-rouge">v-if</code>가 디렉티브중 하나인데</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">p</span> <span class="nx">v</span><span class="o">-</span><span class="k">if</span><span class="o">=</span><span class="dl">"</span><span class="s2">seen</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">Now</span> <span class="nx">you</span> <span class="nx">see</span> <span class="nx">me</span><span class="o">&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span></code></pre></div></div>
<p>위 코드는 <code class="highlighter-rouge">seen</code> 의 값의 변경에 따라 반응하여 <code class="highlighter-rouge">seen</code> 이 truthy 한 값으로 변경되면 DOM에 <code class="highlighter-rouge">&lt;p&gt;</code> 엘리먼트를 추가하고 falsy 한 값으로 변경되면 DOM에 <code class="highlighter-rouge">&lt;p&gt;</code> 엘리먼트를 삭제하게 된다.</p>

<h2 id="custom-directive">Custom Directive?</h2>

<p>사용자 정의 디렉티브 (custom directive) 란 말 그대로 개발자가 정의한 디렉티브이다. 즉, 전달받은 표현식의 값에 따라 반응형으로 DOM 에 side-effect 를 주는 컴포넌트라고 할 수 있겠다.</p>

<h2 id="문제">문제</h2>

<p>Vue는 주어진 문자열을 <code class="highlighter-rouge">innerHTML</code> 에 넣어 HTML 렌더링 하는 디렉티브로 <code class="highlighter-rouge">v-html</code> 디렉티브를 제공한다. 다만 기본적인 XSS 를 방어할 수 있는 디렉티브는 따로 제공하지 않고, 그럴 생각도 없다고 한다.</p>

<blockquote>
  <p>https://github.com/vuejs/vue/issues/7860</p>
</blockquote>

<p>문제가 되는 경우는 NCR 을 렌더링 해야 하는 경우인데, 렌더링은 해야겠고 XSS는 막아야겠으니 <code class="highlighter-rouge">&lt;</code> 와 <code class="highlighter-rouge">&gt;</code> 만 escape 하는 커스텀 디렉티브를 만들어야겠다고 결심한다.</p>

<blockquote>
  <p>NCR (Numeric Character Reference) 에 대해서는 다음을 참고하자. https://en.wikipedia.org/wiki/Numeric_character_reference</p>
</blockquote>

<p>아마 다음과 같이 구현할 수 있을 것이다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">escapeTag</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">binding</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">fakeElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">div</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">fakeElement</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">binding</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
  <span class="nx">el</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nx">fakeElement</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">Vue</span><span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="dl">'</span><span class="s1">escape-tag</span><span class="dl">'</span><span class="p">,</span> <span class="nx">escapeTag</span><span class="p">);</span>
</code></pre></div></div>

<pre><code class="language-HTML">&lt;div&gt;
  &lt;span class="test" v-escape-tag='"&amp;#9822"'&gt;&lt;/span&gt;
&lt;/div&gt;
</code></pre>

<p><code class="highlighter-rouge">v-escape-tag</code>에 <code class="highlighter-rouge">&amp;#9822</code> 를 넣으면 의도한대로 <code class="highlighter-rouge">♞</code> 가 출력되는걸 볼 수 있다.</p>

<p>이 디렉티브가 virtual dom 과 만나면 굉장히 기묘한 일이 발생하게 된다.</p>

<pre><code class="language-HTML">&lt;div&gt;
  &lt;span v-if="!a" class="test" v-escape-tag="'&amp;#9822'"&gt;&lt;/span&gt;
  &lt;span v-if="a" class="test"&gt;기본 텍스트&lt;/span&gt;
&lt;/div&gt;
</code></pre>

<p>다음과 같이 <code class="highlighter-rouge">a</code>의 값에 따라서 두 <code class="highlighter-rouge">&lt;span&gt;</code> 중 하나를 노출한다고 가정해보자.</p>

<p><code class="highlighter-rouge">a</code> 가 처음에 false 일때는 ‘♞’ 만 보이다가 true로 바뀌는 순간 ‘♞기본 텍스트’ 로 노출되게 된다.
분명 다른 element 로 변경되었는데 기존에 있던 ‘♞’가 지워지지 않게 된것.</p>

<p>그 이유는 첫번째 <code class="highlighter-rouge">span</code> 에서 두번째 <code class="highlighter-rouge">span</code> 으로 변경될 때 뷰의 virtual dom 이 해당 element 를 재활용하기 때문인데, 디렉티브가 <code class="highlighter-rouge">unbind</code> 될 때의 훅이 설정되어 있지 않아서 ♞가 지워지지 않고 남아있게 되는것이다.</p>

<h2 id="해결">해결</h2>

<p>해결책은 간단한데, <code class="highlighter-rouge">Vue.directive(...)</code>의 인자로 함수가 아니라 각 훅마다 동작할 콜백이 정의된 객체를 넘기는 것이다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Vue</span><span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="dl">'</span><span class="s1">escape-tag</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">bind</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">binding</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">fakeElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">div</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">fakeElement</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">binding</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="nx">el</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nx">fakeElement</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">unbind</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">binding</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">el</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span> <span class="c1">// unbind 될 때 innerText 를 초기화 해 준다.</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<p>이처럼 <code class="highlighter-rouge">Vue.directive()</code> 함수 파라미터로 전달해줄 객체에 선언할 수 있는 훅은 다음과 같다.</p>

<ul>
  <li>bind: 디렉티브가 엘리먼트에 처음 바인딩 되었을 때</li>
  <li>inserted: 바인딩 된 엘리먼트가 부모 노드에 삽입되었을 </li>
  <li>update: 포함하는 컴포넌트가 업데이트 되었을 때, 하지만 자식 컴포넌트가 업데이트 된 것을 보장하지는 않는다.</li>
  <li>componentUpdated: 포함하는 컴포넌트와, 그 컴포넌트의 자식 컴포넌트가 모두 업데이트 되었을 때</li>
  <li>unbind: 디렉티브가 엘리먼트에 처음 언바인딩 되었을 때</li>
</ul>

<p>각 훅에 파라미터로 전달되는 객체는 다음과 같다.</p>

<ul>
  <li>el: 디렉티브가 바인딩될 엘리먼트</li>
  <li>binding
    <ul>
      <li>name: 디렉티브 이름, v- 프리픽스가 없습니다.</li>
      <li>value: 디렉티브에서 전달받은 값.</li>
      <li>oldValue: 이전 값.</li>
      <li>expression: 표현식 문자열. v-my-directive=”1 + 1” -&gt; “1 + 1”</li>
      <li>arg: 디렉티브의 전달인자, 있는 경우에만 존재합니다. v-my-directive:foo -&gt; “foo”</li>
      <li>modifiers: 포함된 수식어 객체, 있는 경우에만 존재한다. v-my-directive.foo.bar -&gt; { foo: true, bar: true }</li>
    </ul>
  </li>
  <li>vnode: Vue 컴파일러가 만든 버추얼 노드.</li>
  <li>oldVnode: 이전의 버추얼 노드.</li>
</ul>

<h2 id="결론">결론</h2>

<p>Custom Directive 를 구현할 때는 상황에 맞게 훅을 구현해주는것이 좋다.</p>


<span class="post-date">
  Written on
  
  April
  26th,
  2019
  by
  
    genie-youn
  
</span>

<div class="post-date">Feel free to share!</div>
  <div class="sharing-icons">
    <a href="https://twitter.com/intent/tweet?text=Vue 디렉티브와 Hook&amp;url=/journal/Vue%EC%99%80-Custom-Directive.html" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
    <a href="https://www.facebook.com/sharer/sharer.php?u=/journal/Vue%EC%99%80-Custom-Directive.html&amp;title=Vue 디렉티브와 Hook" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a>
    <a href="https://plus.google.com/share?url=/journal/Vue%EC%99%80-Custom-Directive.html" target="_blank"><i class="fa fa-google-plus" aria-hidden="true"></i></a>
  </div>
</div>


<div class="related">
  <h1 >You may also enjoy:</h1>
  
  <ul class="related-posts">
    
      
        
          <li>
            <h3>
              <a href="/journal/%EB%B2%88%EC%97%AD-Vue.js-3-Future-Oriented-Programming.html">
                [번역]Vue.js 3: Future-Oriented Programming
                <!--<img src="http://localhost:4000/images/">-->
                <!--<small>August 23, 2019</small>-->
              </a>
            </h3>
          </li>
          
        
      
        
          <li>
            <h3>
              <a href="/journal/Vue%EB%8A%94-%EC%99%9C-Filter%EB%A5%BC-%EC%82%AD%EC%A0%9C%ED%95%98%EB%A0%A4-%ED%96%88%EC%9D%84%EA%B9%8C.html">
                Vue는 왜 filter를 삭제하려고 했을까?
                <!--<img src="http://localhost:4000/images/">-->
                <!--<small>June 19, 2019</small>-->
              </a>
            </h3>
          </li>
          
        
      
        
        
      
    
  </ul>
</div>



  <section class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = "blog-RDzIu87BYM";
    var disqus_identifier = "/journal/Vue%EC%99%80-Custom-Directive.html";
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>



    </div>

    <footer class="footer">
  
  
  
    <a href="https://github.com/genie-youn" target="_blank"><i class="fa fa-github" aria-hidden="true"></i></a>
  

  
  
    <a href="https://www.linkedin.com/in/%EC%A7%80%EC%88%98-%EC%9C%A4-78921a11b/" target="_blank"><i class="fa fa-linkedin" aria-hidden="true"></i></a>
  

  
  
    <a href="mailto:yjs930915@gmail.com" target="_blank"><i class="fa fa-envelope" aria-hidden="true"></i></a>
  

  <div class="post-date"><a href="/menu/about.html">오르막길 | 잊기전에 기록하기 by genie-youn</a></div>
</footer>

  </div>

</body>
</html>
